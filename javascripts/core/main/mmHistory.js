define(["avalon"],function(avalon){function targetIsThisWindow(targetWindow){return!targetWindow||targetWindow===window.name||"_self"===targetWindow||"top"===targetWindow&&window==window.top}function getFirstAnchor(list){for(var el,i=0;el=list[i++];)if("A"===el.nodeName)return el}function scrollToAnchorId(hash,el){(el=document.getElementById(hash))?el.scrollIntoView():(el=getFirstAnchor(document.getElementsByName(hash)))?el.scrollIntoView():window.scrollTo(0,0)}var History=avalon.History=function(){this.location=window.location,this.history=window.history};History.started=!1,History.IEVersion=function(){var mode=document.documentMode;return mode?mode:window.XMLHttpRequest?7:6}(),History.defaults={root:"/",html5Mode:!1,hashPrefix:"!",iframeID:null,interval:50,fireAnchor:!0,routeElementJudger:avalon.noop};var oldIE=window.VBArray&&History.IEVersion<=7,supportPushState=!!window.history.pushState,supportHashChange=!(!("onhashchange"in window)||window.VBArray&&oldIE);return History.started=!1,History.prototype={constructor:History,atRoot:function(){var path=this.location.pathname.replace(/[^\/]$/,"$&/");return path===this.root&&!this.getSearch()},matchRoot:function(){var path=this.decodeFragment(this.location.pathname),root=path.slice(0,this.root.length-1)+"/";return root===this.root},decodeFragment:function(fragment){return decodeURI(fragment.replace(/%25/g,"%2525"))},getSearch:function(){var match=this.location.href.replace(/#.*/,"").match(/\?.+/);return match?match[0]:""},getHash:function(window){var path=(window||this).location.href;return this._getHash(path.slice(path.indexOf("#")))},_getHash:function(path){return 0===path.indexOf("#/")?decodeURI(path.slice(2)):0===path.indexOf("#!/")?decodeURI(path.slice(3)):""},getPath:function(){var path=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===path.charAt(0)?path.slice(1):path},getFragment:function(fragment){return null==fragment&&(fragment="popstate"===this.monitorMode?this.getPath():this.getHash()),fragment.replace(/^[#\/]|\s+$/g,"")},start:function(options){function checkUrlChange(){if(!History.started)return!1;var current=that.getFragment();return current===that.fragment&&that.iframe&&(current=that.getHash(that.iframe.contentWindow)),current!==that.fragment&&(that.iframe&&that.navigate(current),void that.fireUrlChange())}if(History.started)throw new Error("avalon.history has already been started");options=options||{},options.basepath&&(options.root=options.basepath,delete options.basepath),History.started=!0,this.options=avalon.mix({root:"/"},History.defaults,options),this.html5Mode=!!this.options.html5Mode,this.monitorMode=this.html5Mode?"popstate":"hashchange",supportPushState||(this.html5Mode&&(avalon.log("如果浏览器不支持HTML5 pushState，强制使用hash hack!"),this.html5Mode=!1),this.monitorMode="hashchange"),supportHashChange||(this.monitorMode="iframepoll"),this.prefix="#"+this.options.hashPrefix+"/",this.root=("/"+this.options.root+"/").replace(/^\/+|\/+$/g,"/"),this.fragment=this.getFragment();var hasHash=this.atRoot();"popstate"===this.monitorMode&&supportPushState&&hasHash&&this.navigate(this.getHash(),{replace:!0});var that=this;switch(this.monitorMode){case"popstate":this._checkUrlChange=avalon.bind(window,"popstate",checkUrlChange);break;case"hashchange":this._checkUrlChange=avalon.bind(window,"hashchange",checkUrlChange);break;case"iframepoll":this._intervalID=setInterval(checkUrlChange,this.interval),avalon.ready(function(){var iframe=that.iframe=document.createElement("iframe");iframe.src="javascript:0",iframe.style.display="none",iframe.tabIndex=-1;var body=document.body,iWindow=body.insertBefore(iframe,body.firstChild).contentWindow;iWindow.document.open(),iWindow.document.close(),iWindow.location.hash=that.prefix+that.fragment})}if(!this.options.silent)return this.fireUrlChange()},stop:function(){switch(this.monitorMode){case"popstate":avalon.unbind(window,"popstate",this._checkUrlChange);break;case"hashchange":avalon.unbind(window,"hashchange",this._checkUrlChange);break;case"iframepoll":this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),clearInterval(this._intervalID)}History.started=!1},fireUrlChange:function(fragment){fragment=this.fragment=this.getFragment(fragment),avalon.router&&(avalon.router.setLastPath(fragment),avalon.router.navigate(fragment)),this.options.fireAnchor&&scrollToAnchorId(fragment.replace(/\?.*/g,""))},navigate:function(fragment,options){if(!History.started)return!1;options&&options!==!0||(options={trigger:options}),fragment=this.getFragment(fragment||"");var root=this.root;""!==fragment&&"?"!==fragment.charAt(0)||(root=root.slice(0,-1)||"/");var url=root+fragment;if(fragment=this.decodeFragment(fragment.replace(/#.*$/,"")),this.fragment!==fragment){if(this.fragment=fragment,"popstate"===this.monitorMode)this.history[options.replace?"replaceState":"pushState"]({},document.title,url);else{if(this.options.html5Mode)return this.location.assign(url);if(this._updateHash(this.location,fragment,options.replace),this.iframe&&fragment!==this.getHash(this.iframe.contentWindow)){var iWindow=this.iframe.contentWindow;options.replace||(iWindow.document.open(),iWindow.document.close()),this._updateHash(iWindow.location,fragment,options.replace)}}return options.trigger?this.fireUrlChange(fragment):void 0}},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+this.prefix+fragment)}else location.hash=this.prefix+fragment}},avalon.history=new History,avalon.bind(document,"click",function(event){var defaultPrevented="defaultPrevented"in event?event.defaultPrevented:event.returnValue===!1;if(History.started&&!defaultPrevented&&!event.ctrlKey&&!event.metaKey&&2!==event.which){for(var target=event.target;"A"!==target.nodeName;)if(target=target.parentNode,!target||"BODY"===target.tagName)return;if(targetIsThisWindow(target.target)){var href=target.getAttribute("href",2)||target.getAttribute("xlink:href"),prefix=avalon.history.prefix;if(null===href)return;var hash=href.replace(prefix,"").trim();if(0!==href.indexOf(prefix)||""===hash){var routeElementJudger=avalon.history.options.routeElementJudger;hash=routeElementJudger(target,href),hash===!0&&(hash=href)}hash&&(event.preventDefault(),avalon.history.navigate(hash,!0))}}}),avalon});